# 포인트 환전소 (Point Exchanger) 기획서

> 작성자: PlanClaw  
> 작성일: 2026-02-17  
> 버전: v1.1  
> 상태: 초안

---

## 1. 개요

랜드 생태계(게임랜드 / 플레이랜드 / 오피스랜드) 내 **연동된 계정 간 포인트를 교환**할 수 있는 공통 서비스.  
각 서비스 UI에 교환소를 구현하고, 이를 `ms-point-exchanger` 마이크로서비스와 연동한다.

---

## 2. 배경 및 목적

- 랜드 서비스들이 분리 운영되면서 포인트 생태계도 서비스별로 분리됨
- 사용자는 한 서비스에서 획득한 포인트를 다른 서비스에서 사용하고 싶어 함
- 계정 연동 기능과 결합하여 형제 서비스 간 포인트 순환 생태계 구축
- 수익성은 현재 없고, 유저 락인(Lock-in) 및 생태계 활성화 목적

---

## 3. 아키텍처

```
[각 서비스 FE]
      │ (환전 요청 UI)
      ▼
[각 서비스 BE] ──────────────────────────────────┐
      │                                           │
      ▼                                           │
[ms-point-exchanger]                              │
  - 환전 요청 처리                                  │
  - 환율 적용                                      │
  - 멱등성 보장                                    │
  - 유저별 락(Lock) 관리                           │
      │                                           │
      ├──▶ [source 서비스 BE] → 포인트 차감         │
      └──▶ [target 서비스 BE] → 포인트 지급         │
```

**서비스 간 통신 방향**:  
서비스 FE → 서비스 BE → point exchanger → (source BE: 차감) + (target BE: 지급)

---

## 4. 연동 대상 서비스

| 서비스 | 포인트 구현 현황 | 비고 |
|--------|----------------|------|
| 게임랜드 | ✅ 구현 완료 | `user_point_wallets`, `points_use`/`points_issue` RPC |
| 플레이랜드 | ✅ 구현 완료 | 게임랜드와 유사한 구조 |
| 오피스랜드 | ❌ 미구현 | **선행 작업 필요** — game-land 참고해서 포인트 기능 먼저 활성화 |

> ⚠️ **블로커**: 오피스랜드 포인트 기능이 없으면 환전소 연동 불가. 우선 게임랜드 ↔ 플레이랜드 환전 먼저 구현 가능.

---

## 5. 기능 정의

### 5.1 환전 신청

- 유저가 A 서비스에서 B 서비스로 포인트 환전 요청
- 환전 전 계정 연동 여부 확인 필수
- 환전 가능 포인트 잔액 표시
- 환전 수량 입력 (최소/최대 단위 미정, 1포인트 단위 가능)
- 최종 수령 포인트 미리보기 (환율 적용 후)

### 5.2 환전 처리

- 원자적(Atomic) 처리: 차감 실패 시 지급 없음, 지급 실패 시 차감 롤백
- 멱등성 키(Idempotency Key) 기반 중복 요청 방지
- 유저별 환전 락(Lock): 동시 요청 시 하나만 처리
- 처리 완료 후 각 서비스 포인트 지갑에 즉시 반영

### 5.3 환전 내역 조회

- 환전 일시, 방향(A→B), 차감 포인트, 지급 포인트 조회
- 서비스별 환전 내역 페이지 제공

### 5.4 환율 관리 (어드민)

- 기본 환율: **1:1**
- 관리자가 서비스 쌍(pair)별로 환율 직접 설정 가능
- 환율 변경 이력 관리

---

## 6. 환전 규칙

| 항목 | 내용 |
|------|------|
| 기본 환율 | 1:1 |
| 환율 설정 | 관리자 직접 지정 (서비스 쌍별 개별 설정 가능) |
| 수수료 | 없음 |
| 최소 환전 단위 | 없음 (MVP 기준) |
| 최대 환전 한도 | 없음 (MVP 기준) |
| 환전 취소 | 불가 (완료 후 재환전으로 처리) |

---

## 7. 유저 시나리오

### 시나리오 A: 게임랜드 → 플레이랜드 포인트 환전 (정상)

1. 유저가 게임랜드 내 "포인트 환전소" 메뉴 진입
2. 연동된 플레이랜드 계정 확인 (미연동 시 계정 연동 안내)
3. 환전할 포인트 수량 입력
4. 현재 환율(기본 1:1) 및 수령 예정 포인트 확인
5. 환전 신청 버튼 클릭
6. 처리 완료 → 게임랜드 포인트 차감 + 플레이랜드 포인트 지급
7. 환전 완료 알림 및 내역 확인

### 시나리오 B: 잔액 부족 시

1. 유저가 보유 포인트 초과 수량 입력
2. 잔액 부족 에러 메시지 표시
3. 환전 신청 불가

### 시나리오 C: 계정 미연동 시

1. 유저가 환전 대상 서비스 계정 미연동 상태
2. "계정 연동이 필요합니다" 안내 + 계정 연동 페이지로 이동
3. 연동 완료 후 환전 진행 가능

### 시나리오 D: 동시 요청 (중복 방지)

1. 유저가 환전 버튼을 여러 번 연타
2. 첫 번째 요청만 처리 (유저별 락 적용)
3. 중복 요청은 "처리 중입니다" 응답 반환

---

## 8. 비즈니스 시나리오 (What to Test)

### 핵심 시나리오

| # | 시나리오 | 기대 결과 |
|---|----------|-----------|
| T1 | 정상 환전 (계정 연동 상태, 잔액 충분) | source 포인트 차감, target 포인트 지급 |
| T2 | 잔액 부족 상태에서 환전 시도 | 에러 응답, 포인트 변화 없음 |
| T3 | 계정 미연동 상태에서 환전 시도 | 연동 안내, 환전 불가 |
| T4 | 동시에 같은 유저가 동일 요청 2회 | 1회만 처리됨 (멱등성 보장) |
| T5 | 환전 중 지급 서버 장애 | 차감 롤백, 유저 포인트 원상복구 |
| T6 | 관리자가 환율 변경 후 환전 | 변경된 환율 적용 |
| T7 | 환전 내역 조회 | 완료된 환전 기록 정확히 표시 |

---

## 9. 기술 요구사항

| 항목 | 요구사항 |
|------|---------|
| 멱등성 | 클라이언트 측 idempotency key 생성 → 중복 요청 방지 |
| 동시성 | 유저별 분산 락(distributed lock) 적용 |
| 원자성 | 차감 + 지급 트랜잭션 보장 (실패 시 롤백) |
| 확장성 | 포인트 코드 추상화 → 신규 서비스 추가 시 설정만으로 연동 가능 |
| 감사 로그 | 모든 환전 요청/응답 로깅 |

---

## 10. 데이터 모델 개요 (WorkClaw/kyago 검토 필요)

### exchange_requests (환전 요청 내역)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid | PK |
| idempotency_key | varchar | 클라이언트 멱등성 키 |
| user_id | uuid | 유저 ID |
| source_service | varchar | 출발 서비스 코드 (game-land 등) |
| target_service | varchar | 목적 서비스 코드 |
| source_amount | int | 차감 포인트 |
| target_amount | int | 지급 포인트 |
| exchange_rate | decimal | 적용 환율 |
| status | enum | PENDING / SUCCESS / FAILED / ROLLED_BACK |
| created_at | timestamp | |
| completed_at | timestamp | |

### exchange_rates (환율 설정)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | uuid | PK |
| source_service | varchar | |
| target_service | varchar | |
| rate | decimal | 환율 (기본 1.0) |
| is_active | boolean | |
| updated_by | uuid | 관리자 ID |
| updated_at | timestamp | |

---

## 11. 제약 사항

- 계정 연동 선행 필수 (포인트 환전 전 계정 연동이 완료되어 있어야 함)
- 오피스랜드 포인트 기능 구현 전까지 오피스랜드 환전 불가
- 환전 취소 기능 없음 (정책 결정)
- 수수료 없음 (정책 결정)

---

## 12. 일정

| 항목 | 담당 | 완료 목표 |
|------|------|---------|
| 오피스랜드 포인트 기능 구현 | Garden/bon | 최우선 |
| ms-point-exchanger 마이크로서비스 구현 | kyago/WorkClaw | 이번 주 내 |
| 각 서비스 UI 환전소 페이지 구현 | bon/Reus | 이번 주 내 |
| 각 서비스 BE 연동 | kyago/bon | 이번 주 내 |
| 통합 테스트 | 전체 | 주말 전 |
| 운영 배포 | Garden | 주말 중 |

---

## 13. 결정 사항 (Decisions)

| # | 질문 | 결정 | 확인자 |
|---|------|------|--------|
| 1 | 최소/최대 환전 한도 | MVP에서 없음 | Reus (2026-02-17) |
| 2 | 실패 알림 UX | 토스트(Toast)로 처리 | Reus (2026-02-17) |
| 3 | 어드민 환율 관리 UI | MVP에서 불필요 → DB 직접 수정 | Reus (2026-02-17) |

## 14. 열린 질문 (Open Questions)

- [ ] 오피스랜드 포인트 기능 구현 일정 확정 필요 (Garden)
- [ ] 환전 내역 보존 기간 정책 필요

---

_PlanClaw — 2026-02-17_
